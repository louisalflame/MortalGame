# GameModel 系統 - MortalGame 核心遊戲邏輯架構

## 🎯 GameModel 系統定位與架構價值

**GameModel 是 MortalGame 專案的核心遊戲邏輯層**，實現了完整的卡牌遊戲戰鬥系統架構。此系統採用**數據驅動設計**與**分層架構模式**，建立了從靜態配置到動態執行的完整資料流轉，並透過精密的**條件-動作-效果**協作機制實現複雜的遊戲邏輯。

## 🏗️ GameModel 核心架構總覽

### 六大子系統協作架構

#### 資料流轉層
**[Instance 系統](Instance.md)** - 遊戲局級持久化物件管理  
**[Entity 系統](Entity.md)** - 戰鬥實體動態狀態管理

#### 邏輯執行層
**[Effect 系統](Effect.md)** - 遊戲效果定義與執行機制  
**[Action 系統](Action.md)** - 遊戲動作識別與追蹤機制

#### 條件判定層
**[Condition 系統](Condition.md)** - 多層條件判定組裝機制  
**[Target 系統](Target.md)** - 目標指定與條件判斷機制

## 📊 Data-Instance-Entity 三層資料架構

### 資料流轉核心設計
GameModel 建立了完整的三層資料流轉機制，確保從靜態配置到動態執行的無縫轉換：

#### 資料層轉換流程
```
GameData (靜態定義)
    ↓ 遊戲開始時轉換
Instance (持久狀態)
    ↓ 戰鬥開始時實體化
Entity (動態實體)
    ↓ 戰鬥結束時回寫
Instance (更新狀態)
    ↓ 整局遊戲結束
GameData (保持不變)
```

### 各層級職責與生命週期

#### GameData 層 - 靜態資料定義
**生命週期**：專案開發期間定義，執行期間不變  
**職責範圍**：
- **卡牌定義**：所有卡牌的基礎屬性、效果、觸發條件
- **角色定義**：角色的基礎數值、技能、成長配置
- **效果規則**：遊戲機制的規則定義與平衡數值
- **編輯器配置**：透過 Odin Inspector 提供設計師友善的編輯介面

#### Instance 層 - 持久狀態管理
**生命週期**：整局遊戲的開始到結束（跨多場戰鬥）  
**職責範圍**：
- **玩家進度**：玩家在整局遊戲中的成長與收集狀態
- **卡牌收集**：玩家獲得的卡牌個體與強化狀態
- **關係狀態**：角色好感度、劇情進度等持久性狀態
- **配置保存**：牌組配置、設定偏好等跨戰鬥資訊

#### Entity 層 - 動態戰鬥實體
**生命週期**：單場戰鬥的開始到結束  
**職責範圍**：
- **戰鬥狀態**：生命值、能量、護甲等即時戰鬥數值
- **臨時效果**：Buff、Debuff、臨時屬性修改等戰鬥內狀態
- **動態交互**：卡牌使用、目標選擇、效果觸發等即時互動
- **狀態追蹤**：戰鬥過程中的所有狀態變化與事件記錄

### 轉換機制設計原則

#### Instance → Entity 轉換
- **資料繼承**：Entity 繼承 Instance 的基礎數值作為戰鬥起始狀態
- **臨時擴展**：Entity 增加戰鬥專用的臨時狀態與效果管理
- **身份保持**：透過 GUID 維持 Instance 與 Entity 的對應關係

#### Entity → Instance 回寫
- **選擇性回寫**：只有需要跨戰鬥保持的狀態變化才會回寫到 Instance
- **狀態過濾**：戰鬥內的臨時效果被過濾，不影響持久狀態
- **進度更新**：根據戰鬥結果更新 Instance 的成長與收集狀態

## 🔄 Action-Target-Condition-Effect 協作流程

### 遊戲邏輯執行核心機制
GameModel 的核心優勢在於**條件驅動的效果執行機制**，實現了高度靈活且可擴展的遊戲邏輯框架：

#### 完整執行流程
```
1. Action 觸發
   ↓
2. Target 確定目標
   ↓  
3. Condition 條件檢查
   ↓
4. Effect 效果執行
   ↓
5. Action 結果記錄
   ↓
6. 反應觸發循環
```

### 各系統協作機制詳解

#### Action 系統 - 動作識別與追蹤
**協作角色**：**事件發起者與結果記錄者**
- **意圖聲明**：每個動作執行前先透過 IntentAction 聲明意圖
- **來源追蹤**：精確記錄動作的觸發來源（卡牌、角色、系統等）
- **結果記錄**：透過 ResultAction 記錄動作執行的實際效果
- **觸發脈絡**：為後續的條件判斷提供完整的觸發上下文

#### Target 系統 - 目標解析與數值計算
**協作角色**：**目標確定與條件支援者**
- **目標解析**：將抽象的目標描述轉換為具體的遊戲實體
- **動態計算**：基於遊戲狀態進行即時的目標與數值計算
- **選擇支援**：為玩家提供互動式的目標選擇介面
- **條件數值**：為 Condition 系統提供數值比較的數據來源

#### Condition 系統 - 條件判斷與邏輯組合
**協作角色**：**邏輯閘門與觸發控制者**
- **觸發判斷**：根據 Action 提供的觸發上下文判斷是否滿足觸發條件
- **目標驗證**：利用 Target 系統的數值計算進行條件驗證
- **邏輯組合**：支援 AND、OR、NOT 等複雜邏輯的條件組合
- **效果控制**：決定哪些 Effect 在當前情況下應該被執行

#### Effect 系統 - 效果定義與執行
**協作角色**：**邏輯執行者與狀態修改者**
- **效果執行**：根據 Condition 的判斷結果執行相應的遊戲效果
- **狀態修改**：直接修改 Entity 系統中的遊戲狀態
- **結果生成**：產生標準化的效果執行結果供 Action 系統記錄
- **連鎖觸發**：效果執行後可能觸發新的 Action，形成反應鏈

## 🛡️ Entity 多層級實體管理

### 戰鬥實體架構核心
**[Entity 系統](Entity.md)** 在 GameModel 中承擔**戰鬥狀態管理**的核心角色：

#### 三層實體分工
- **[Player 系統](Player.md)**：陣營級資源管理（能量、手牌、性情、PlayerBuff）
- **[Character 系統](Character.md)**：單位級狀態管理（生命、護甲、CharacterBuff）  
- **[Card 系統](Card.md)**：資源級實體管理（卡牌狀態、區域轉移、CardBuff）

#### 特殊機制整合
- **[Session 系統](Session.md)**：跨實體的臨時狀態與計數機制
- **三重增益系統**：PlayerBuff/CharacterBuff/CardBuff 的目標特化設計

## 🌐 與其他系統的協作關係

### 與 GameView 系統協作
**資料來源**：GameModel 為 GameView 提供所有需要視覺化的遊戲狀態資料

### 與 Presenter 系統協作  
**邏輯核心**：GameModel 處理所有遊戲邏輯，Presenter 負責協調與轉換

### 與 UI 系統協作
**狀態驅動**：GameModel 的狀態變化驅動 UI 的動態更新與顯示

### 與 Scene 系統協作
**生命週期管理**：Scene 管理 GameModel 實例的創建、使用與銷毀

---

**系統複雜度**：⭐⭐⭐⭐⭐ (最高複雜度的核心邏輯系統)  
**維護重點**：資料流轉一致性、系統協作穩定性、效能優化、邏輯正確性